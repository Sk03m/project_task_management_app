<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body { font-family: Arial, sans-serif; }
        .task-status-pending { color: orange; }
        .task-status-completed { color: green; }
        .task-status-overdue { color: red; }
    </style>
</head>
<body class="container pt-4">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Welcome, {{ current_user.username }}!</h2>
    <a href="/logout" class="btn btn-outline-secondary">Logout</a>
</div>

{% if admin %}
<div class="row mb-5">
    <div class="col-md-6">
        <h3>Team Members</h3>
        <ul class="list-group">
            {% for user in users %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ user.username }} ({{ user.email }})
                {% if user.id != current_user.id %}
                <button onclick="removeUser({{ user.id }})" class="btn btn-danger btn-sm">Remove</button>
                {% endif %}
            </li>
            {% endfor %}
        </ul>

        <h4 class="mt-4">Add Team Member</h4>
        <form id="addUserForm" class="mb-3">
            <input type="text" name="username" placeholder="Username" class="form-control mb-2" required>
            <input type="email" name="email" placeholder="Email" class="form-control mb-2" required>
            <input type="password" name="password" placeholder="Password" class="form-control mb-2" required>
            <button type="submit" class="btn btn-success">Add User</button>
        </form>
    </div>
</div>
{% endif %}

<div class="col-md-12">
    <h3>Tasks</h3>
    {% if tasks|length == 0 %}
        <p>No tasks found</p>
    {% else %}
    <ul class="list-group">
        {% for task in tasks %}
        <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ task.title }}</strong><br>
                    <small class="text-muted">{{ task.description }}</small><br>
                    Assigned to: {{ task.user.username }}<br>
                    Status: <span class="task-status-{{ task.status|lower }}">{{ task.status }}</span><br>
                    Deadline: {{ task.deadline.strftime('%Y-%m-%d %H:%M') if task.deadline else 'None' }}
                </div>

                <div>
                    {% if task.status != 'Completed' %}
                    <form class="completeTaskForm" data-task-id="{{ task.id }}" enctype="multipart/form-data">
                        <input type="file" name="completion_file" accept=".pdf,.doc,.docx,.ppt,.pptx" required><br>
                        <button type="submit" class="btn btn-success btn-sm mt-2">Mark Done</button>
                    </form>
                    {% else %}
                    {% if task.file_name %}
                        <a href="{{ url_for('main.uploaded_file', filename=task.file_name) }}" target="_blank" class="btn btn-info btn-sm">View File</a>
                    {% else %}
                        <span>No file uploaded</span>
                    {% endif %}
                    {% endif %}
                    <button onclick="deleteTask({{ task.id }})" class="btn btn-danger btn-sm mt-2">Delete</button>
                </div>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<h4 class="mt-4">Add Task</h4>
<form id="addTaskForm" class="mb-4">
    <input type="text" name="title" placeholder="Title" class="form-control mb-2" required>
    <textarea name="description" placeholder="Description" class="form-control mb-2"></textarea>
    <input type="datetime-local" name="deadline" class="form-control mb-2" placeholder="Deadline">
    <select name="assigned_to" class="form-select mb-2">
        {% if admin %}
            {% for user in users %}
            <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
        {% else %}
            <option value="{{ current_user.id }}">{{ current_user.username }}</option>
        {% endif %}
    </select>
    <button type="submit" class="btn btn-primary">Add Task</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Add User Submit
document.getElementById('addUserForm')?.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    const res = await fetch('/add_user', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
    });
    const result = await res.json();
    alert(result.message || result.error);
    if(res.ok) location.reload();
});

// Add Task Submit
document.getElementById('addTaskForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    const res = await fetch('/add_task', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
    });
    const result = await res.json();
    alert(result.message || result.error);
    if(res.ok) location.reload();
});

// Remove User
async function removeUser(userId) {
    if(!confirm('Remove this user?')) return;
    const res = await fetch(`/remove_user/${userId}`, {method:'DELETE'});
    const result = await res.json();
    alert(result.message || result.error);
    if(res.ok) location.reload();
}

// Delete Task
async function deleteTask(taskId) {
    if(!confirm('Delete this task?')) return;
    const res = await fetch(`/delete_task/${taskId}`, {method:'DELETE'});
    const result = await res.json();
    alert(result.message || result.error);
    if(res.ok) location.reload();
}

// Complete Task with file upload
document.querySelectorAll('.completeTaskForm').forEach(form => {
    form.addEventListener('submit', async e => {
        e.preventDefault();
        const taskId = form.getAttribute('data-task-id');
        const fileInput = form.querySelector('input[name="completion_file"]');
        if (!fileInput.files.length) {
            alert("Please upload a file to mark work as done.");
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const res = await fetch(`/complete_task/${taskId}`, {
            method: 'PUT',
            body: formData
        });
        const result = await res.json();
        alert(result.message || result.error);
        if(res.ok) location.reload();
    });
});
</script>
</body>
</html>
